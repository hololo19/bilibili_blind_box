# 代码验证清单

## 后端 (web_server.py)

### ✅ 导入和配置
- [x] Flask 和 Flask-SocketIO 导入
- [x] 数据目录创建：`DATA_DIR`
- [x] 日期文件名：`f"blind_box_data_{date.today().isoformat()}.json"`

### ✅ 数据保存/加载
- [x] `save_to_file()` 使用当前日期文件名
- [x] `load_from_file()` 检查日期匹配
- [x] `total_stats` 包含 `profit_count` 和 `loss_count`

### ✅ 监听器控制
- [x] `/api/config` - GET/POST 配置管理
- [x] `/api/monitor/start` - 启动监听器
- [x] `/api/monitor/stop` - 停止监听器
- [x] `/api/monitor/status` - 获取状态
- [x] 配置保存到 `monitor_config.json`
- [x] WebSocket推送 `monitor_status`

### ✅ API返回数据
- [x] `/api/stats` 返回 `profit_count` 和 `loss_count`
- [x] 统计更新时推送盈利/亏损数量

---

## 前端 (templates/index.html)

### ✅ 配置面板
- [x] 房间号输入框
- [x] Cookie输入框
- [x] 开始/停止按钮
- [x] 状态显示（未启动/运行中）
- [x] 样式完整（config-panel相关）

### ✅ 统计卡片
- [x] 总盲盒数
- [x] 盈利盲盒（💚图标）
- [x] 亏损盲盒（❤️图标）
- [x] 总盈亏
- [x] 参与人数
- [x] 移除了总花费和总价值

### ✅ JavaScript功能
- [x] 页面加载时获取配置
- [x] 页面加载时获取监听器状态
- [x] `toggleMonitor()` 启动/停止监听器
- [x] `updateMonitorStatus()` 更新UI状态
- [x] `socket.on('stats_update')` 更新盈利/亏损数量

### ✅ WebSocket事件
- [x] `monitor_status` - 监听器状态更新
- [x] `stats_update` - 统计数据更新
- [x] `new_blind_box` - 新盲盒记录

---

## 监听器 (monitor_with_web.py)

### ✅ 配置文件支持
- [x] 导入 `os`, `Path`, `json`
- [x] `CONFIG_FILE` 路径
- [x] 启动时从配置文件加载
- [x] 支持临时配置 `monitor_temp_config.json`

---

## 潜在问题检查

### 1. total_stats 初始化
当前代码中，`total_stats` 初始化为：
```python
total_stats = {"count": 0, "profit_count": 0, "loss_count": 0, "profit": 0}
```

但在 `load_from_file()` 中，如果JSON文件使用旧的格式（包含cost/value），可能会有问题。

**需要兼容旧数据格式**

### 2. 监听器启动
监听器通过 `subprocess.Popen` 启动，但配置文件中的变量名是：
```python
temp_config = {
    "ROOM_ID": int(monitor_config['room_id']),
    "COOKIE": monitor_config['cookie'],
    "WEB_SERVER_URL": "http://localhost:5000"
}
```

但 monitor_with_web.py 期望的变量名是：
```python
ROOM_ID = ...
COOKIE = ...
WEB_SERVER_URL = ...
```

**需要让监听器从JSON配置读取这些变量**

### 3. HTML文件编码
HTML包含中文注释，可能需要注意文件编码。

---

## 修复建议

### 修复1: 兼容旧数据格式
在 `load_from_file()` 中添加兼容：
```python
total_stats = data.get("total_stats",
    {"count": 0, "profit_count": 0, "loss_count": 0, "profit": 0})

# 兼容旧版本
if "cost" in total_stats and "profit_count" not in total_stats:
    total_stats["profit_count"] = 0
    total_stats["loss_count"] = 0
```

### 修复2: 监听器配置读取
需要修改 monitor_with_web.py 的配置部分，让它能够读取JSON配置文件。

---

## 结论

代码结构基本正确，但需要：
1. 添加旧数据格式兼容
2. 完善监听器配置文件读取
3. 测试实际运行效果

建议先在本地环境测试，确认功能正常后再部署到Docker。
